<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Hours Tracker — Hosted</title>
  <meta name="description" content="Daily hours tracker with weekly summary, graph, streaks, Google Sheets sync and mobile-friendly UI" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, Arial, sans-serif;margin:0;background:linear-gradient(180deg,#071021 0%, #071726 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{max-width:980px;width:100%;display:grid;grid-template-columns:1fr 420px;gap:20px}
    .card{background:rgba(255,255,255,0.03);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .small{font-size:13px;color:var(--muted)}
    label{display:block;font-size:13px;margin-top:8px;color:var(--muted)}
    input[type=number], select, input[type=text], input[type=date]{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:inherit;margin-top:6px}
    button{background:linear-gradient(90deg,#06b6d4,#38bdf8);border:none;color:#022; padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer;margin-top:12px}
    .muted{color:var(--muted)}
    .progress{height:18px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#34d399,#60a5fa)}
    .stat-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;text-align:center}
    .stat strong{display:block;font-size:18px}
    .list{max-height:220px;overflow:auto;margin-top:10px}
    footer{margin-top:12px;font-size:12px;color:var(--muted)}

    /* Responsive */
    @media (max-width:900px){.wrap{grid-template-columns:1fr;}}

    /* small touches */
    .row{display:flex;gap:8px;align-items:center}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Main tracker and charts -->
    <div class="card">
      <header>
        <div>
          <h1>Live Hours Tracker</h1>
          <div class="small">Daily log • Weekly summary • Sync with Google Sheets</div>
        </div>
        <div class="small" id="todayDate"></div>
      </header>

      <!-- INPUT: Add daily hours -->
      <div>
        <label>Choose date</label>
        <input type="date" id="entryDate" />

        <label>Hours studied today</label>
        <input type="number" id="hoursToday" min="0" step="0.25" placeholder="e.g. 2.5" />

        <label>Subject (optional)</label>
        <input type="text" id="subject" placeholder="Polity / History / Optional" />

        <div class="row" style="margin-top:10px">
          <button id="saveBtn">Save Entry</button>
          <button id="syncBtn" style="background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06);">Sync Now</button>
        </div>

        <div id="saveMsg" class="small muted" style="margin-top:8px"></div>
      </div>

      <!-- STATS -->
      <div class="stat-row">
        <div class="stat">
          <div class="small">This Week Total</div>
          <strong id="weekTotal">0h</strong>
        </div>
        <div class="stat">
          <div class="small">Daily Target</div>
          <strong id="dailyTargetDisplay">3h</strong>
        </div>
        <div class="stat">
          <div class="small">Streak</div>
          <strong id="streak">0</strong>
        </div>
      </div>

      <!-- PROGRESS BAR vs weekly target -->
      <div style="margin-top:14px">
        <label class="small">Weekly Target Hours</label>
        <input type="number" id="weeklyTarget" min="0" step="1" value="21" />
        <div style="margin-top:8px" class="progress"><i id="weekFill" style="width:0%"></i></div>
        <div class="small" style="margin-top:6px"><span id="weekPercent">0%</span> of weekly target</div>
      </div>

      <!-- CHART -->
      <div style="margin-top:18px">
        <canvas id="lineChart" height="120"></canvas>
      </div>

      <footer>
        <div class="small">Notes: This app autosaves to your device. To sync across devices, set up Google Sheets sync (see Settings panel) and press <strong>Sync Now</strong>.</div>
      </footer>
    </div>

    <!-- RIGHT: Controls, log and settings -->
    <div class="card">
      <div>
        <label>Daily target hours</label>
        <input type="number" id="dailyTarget" min="0" step="0.25" value="3" />

        <label style="margin-top:10px">Quick add</label>
        <div class="row"><button id="add15">+0.25h</button><button id="add30">+0.5h</button><button id="add1">+1h</button></div>

        <label style="margin-top:12px">Recent entries</label>
        <div class="list" id="entryList"></div>

        <label style="margin-top:12px">Settings</label>
        <div class="small muted">Google Sheets Sync URL</div>
        <input type="text" id="sheetEndpoint" placeholder="Paste your Google Apps Script Web App URL here (optional)" />
        <div class="small muted" style="margin-top:6px">If you enable Sheets sync, the tracker will POST each new entry to that endpoint.
        </div>

        <div style="margin-top:12px" class="center">
          <button id="exportBtn">Export CSV</button>
        </div>

        <div style="margin-top:12px" class="small muted">Made for you — responsive and simple. Hosted via GitHub Pages: paste these files into a repo and enable Pages.</div>
      </div>
    </div>
  </div>

  <script>
    /*************************************************************************
      Live Hours Tracker — Single HTML file
      Features implemented (as requested):
      1) Daily Hours Log
      2) Weekly Hours Summary + progress bar
      5) Line Graph (Chart.js) for daily progress
      8) Streak Counter (consecutive days with >0 hours)
      9) Auto-save to device (localStorage)
      12) Mobile-friendly responsive UI
      15) Google Sheets sync (optional) — requires you to deploy a Google Apps Script web app and paste its URL into the "Google Sheets Sync URL" field.

      How to host: create a GitHub repo, add this file as index.html, and enable GitHub Pages on the main branch (or gh-pages). I will provide step-by-step in chat.
    *************************************************************************/

    // ---- Utilities
    const qs = s => document.querySelector(s);
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Elements
    const entryDate = qs('#entryDate');
    const hoursToday = qs('#hoursToday');
    const subject = qs('#subject');
    const saveBtn = qs('#saveBtn');
    const syncBtn = qs('#syncBtn');
    const saveMsg = qs('#saveMsg');
    const entryList = qs('#entryList');
    const weeklyTarget = qs('#weeklyTarget');
    const weekTotalEl = qs('#weekTotal');
    const weekFill = qs('#weekFill');
    const weekPercent = qs('#weekPercent');
    const lineChartCtx = qs('#lineChart');
    const dailyTarget = qs('#dailyTarget');
    const dailyTargetDisplay = qs('#dailyTargetDisplay');
    const streakEl = qs('#streak');
    const add15 = qs('#add15');
    const add30 = qs('#add30');
    const add1 = qs('#add1');
    const exportBtn = qs('#exportBtn');
    const sheetEndpointInput = qs('#sheetEndpoint');
    const todayDate = qs('#todayDate');

    // Default state keys
    const STORAGE_KEY = 'live_hours_entries_v1';
    const CONFIG_KEY = 'live_hours_config_v1';

    // Load config
    function loadConfig(){
      const raw = localStorage.getItem(CONFIG_KEY);
      const cfg = raw ? JSON.parse(raw) : {dailyTarget:3, weeklyTarget:21, sheetEndpoint: ''};
      dailyTarget.value = cfg.dailyTarget || 3;
      weeklyTarget.value = cfg.weeklyTarget || 21;
      sheetEndpointInput.value = cfg.sheetEndpoint || '';
      dailyTargetDisplay.innerText = (cfg.dailyTarget || 3) + 'h';
    }

    // Save config
    function saveConfig(){
      const cfg = {dailyTarget: Number(dailyTarget.value), weeklyTarget: Number(weeklyTarget.value), sheetEndpoint: sheetEndpointInput.value};
      localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      dailyTargetDisplay.innerText = cfg.dailyTarget + 'h';
      renderAll();
    }

    // Load entries
    function loadEntries(){
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveEntries(entries){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    // Add or replace entry for date
    function upsertEntry(date, hours, subj){
      const entries = loadEntries();
      const idx = entries.findIndex(e => e.date === date);
      const entry = {date, hours: Number(hours), subject: subj || ''};
      if(idx >= 0) entries[idx] = entry; else entries.push(entry);
      // sort descending
      entries.sort((a,b)=> b.date.localeCompare(a.date));
      saveEntries(entries);
      return entry;
    }

    // Delete entry
    function deleteEntry(date){
      let entries = loadEntries();
      entries = entries.filter(e=> e.date !== date);
      saveEntries(entries);
      renderAll();
    }

    // Get ISO week start (Monday) for a given date
    function weekStartISO(dateISO){
      const d = new Date(dateISO + 'T00:00:00');
      const day = (d.getDay() + 6) % 7; // Monday=0
      d.setDate(d.getDate() - day);
      return d.toISOString().slice(0,10);
    }

    // Compute this week's total (from Monday to Sunday)
    function computeWeekTotal(){
      const entries = loadEntries();
      const ws = weekStartISO(todayISO());
      const weekEntries = entries.filter(e=> e.date >= ws && e.date <= todayISO());
      const total = weekEntries.reduce((s,e)=> s + Number(e.hours || 0), 0);
      return {total, weekEntries};
    }

    // Streak: count consecutive days with >0 hours up to today
    function computeStreak(){
      const entries = loadEntries();
      const map = new Map(entries.map(e=> [e.date, Number(e.hours)]));
      let streak = 0;
      let d = new Date();
      while(true){
        const iso = d.toISOString().slice(0,10);
        if(map.get(iso) > 0){streak++; d.setDate(d.getDate() - 1);} else break;
      }
      return streak;
    }

    // Render recent entries
    function renderEntries(){
      const entries = loadEntries();
      const html = entries.slice(0,50).map(e=>{
        return `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600">${e.date} • ${e.hours}h ${e.subject ? '• ' + e.subject : ''}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="window._editEntry('${e.date}')" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--accent)">Edit</button>
            <button onclick="window._deleteEntry('${e.date}')" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:#fca5a5">Delete</button>
          </div>
        </div>`;
      }).join('');
      entryList.innerHTML = html || '<div class="small muted">No entries yet. Add today\'s hours above.</div>';
    }

    window._editEntry = function(date){
      const entries = loadEntries();
      const e = entries.find(x=> x.date === date);
      if(!e) return;
      entryDate.value = e.date;
      hoursToday.value = e.hours;
      subject.value = e.subject || '';
      window.scrollTo({top:0,behavior:'smooth'});
    }
    window._deleteEntry = function(date){ if(confirm('Delete entry for '+date+'?')) deleteEntry(date); };

    // Chart.js setup
    let chart;
    function renderChart(){
      const entries = loadEntries();
      // prepare last 14 days labels
      const days = [];
      for(let i=13;i>=0;i--){ const d = new Date(); d.setDate(d.getDate()-i); days.push(d.toISOString().slice(0,10)); }
      const data = days.map(day=>{
        const e = entries.find(x=> x.date === day);
        return e ? e.hours : 0;
      });

      if(chart){ chart.data.labels = days; chart.data.datasets[0].data = data; chart.update(); }
      else{
        chart = new Chart(lineChartCtx,{
          type:'line',
          data:{labels:days,datasets:[{label:'Hours per day',data:data,fill:true,tension:0.3}]},
          options:{scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}
        });
      }
    }

    // EXPORT CSV
    function exportCSV(){
      const entries = loadEntries();
      let csv = 'date,hours,subject
';
      entries.slice().reverse().forEach(e=> csv += `${e.date},${e.hours},"${(e.subject||'').replace(/"/g,'""')}"
`);
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'hours_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // SYNC to Google Sheets (POST JSON). Requires you to deploy a Google Apps Script Web App and accept anonymous POSTs or register token.
    async function syncToSheet(entry){
      const endpoint = sheetEndpointInput.value.trim();
      if(!endpoint) return {ok:false, msg:'No sheet endpoint configured'};
      try{
        const res = await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(entry)});
        const text = await res.text();
        return {ok: res.ok, msg: text || (res.ok? 'Synced':'Failed')};
      }catch(err){
        return {ok:false,msg:err.message};
      }
    }

    // MAIN render
    function renderAll(){
      loadConfig();
      renderEntries();
      const wt = computeWeekTotal();
      weekTotalEl.innerText = wt.total + 'h';
      const target = Number(weeklyTarget.value || 21);
      const pct = Math.round((wt.total / target) * 100);
      weekFill.style.width = Math.min(Math.max(pct,0),100) + '%';
      weekPercent.innerText = Math.max(0,Math.min(100,pct)) + '%';
      renderChart();
      streakEl.innerText = computeStreak();
      todayDate.innerText = new Date().toLocaleDateString();
    }

    // INITIALIZE
    (function init(){
      entryDate.value = todayISO();
      loadConfig();
      renderAll();

      // Bind events
      saveBtn.addEventListener('click', async ()=>{
        const date = entryDate.value;
        const hrs = Number(hoursToday.value || 0);
        if(!date) return alert('Choose a date');
        if(hrs < 0) return alert('Enter valid hours');
        const subj = subject.value.trim();
        const entry = upsertEntry(date, hrs, subj);
        saveMsg.innerText = 'Saved locally ✓';
        setTimeout(()=> saveMsg.innerText = '',2000);
        saveConfig();
        renderAll();
        // attempt to sync in background (best-effort)
        const result = await syncToSheet(entry);
        if(result.ok) saveMsg.innerText = 'Synced to Sheets ✓'; else if(result.msg && result.msg !== 'No sheet endpoint configured') saveMsg.innerText = 'Sync failed: ' + result.msg;
        setTimeout(()=> saveMsg.innerText = '',2500);
      });

      syncBtn.addEventListener('click', async ()=>{
        // push all entries
        const entries = loadEntries();
        if(entries.length === 0) return alert('No entries to sync');
        saveMsg.innerText = 'Syncing...';
        for(const e of entries){
          // small delay to avoid rate issues
          // eslint-disable-next-line no-await-in-loop
          const r = await syncToSheet(e);
          if(!r.ok){ saveMsg.innerText = 'Sync stopped: ' + r.msg; break; }
        }
        saveMsg.innerText = 'Sync complete';
        setTimeout(()=> saveMsg.innerText = '',2000);
      });

      dailyTarget.addEventListener('change', saveConfig);
      weeklyTarget.addEventListener('change', saveConfig);
      sheetEndpointInput.addEventListener('change', saveConfig);

      add15.addEventListener('click', ()=>{ hoursToday.value = (Number(hoursToday.value||0) + 0.25).toFixed(2); });
      add30.addEventListener('click', ()=>{ hoursToday.value = (Number(hoursToday.value||0) + 0.5).toFixed(2); });
      add1.addEventListener('click', ()=>{ hoursToday.value = (Number(hoursToday.value||0) + 1).toFixed(2); });

      exportBtn.addEventListener('click', exportCSV);

      // expose save/delete for buttons inside entry list
      window._saveConfig = saveConfig;
    })();
  </script>
</body>
</html>
