<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Hours Tracker</title>
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0b1020;--muted:#5b6270;--accent:#6b46c1}
    [data-theme='dark']{--bg:#0b0d12;--card:#0f1720;--text:#e6eef8;--muted:#9aa4b2;--accent:#8b5cf6}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:var(--text);padding:18px}
    .app{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .top-row{display:flex;flex-wrap:wrap;gap:12px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(11,16,32,0.06)}
    .small{font-size:13px;color:var(--muted)}
    .big{font-size:28px;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    button{background:var(--accent);color:white;border:0;padding:8px 10px;border-radius:10px;cursor:pointer}
    input{padding:8px;border-radius:8px;border:1px solid #dfe6f2;background:transparent;color:var(--text)}
    .log-list{max-height:220px;overflow:auto}
    .log-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px dashed rgba(11,16,32,0.06);margin-bottom:8px}
  </style>
</head>
<body>
  <div class="app" id="app" data-theme>
    <header class="card">
      <div>
        <h1>Live Hours Tracker</h1>
        <div class="small" id="todayDate">--</div>
        
        <!-- SINGLE TIMER BLOCK -->
        <div style="margin-top:12px;padding:12px;border:1px dashed #ccc;border-radius:10px;text-align:center">
          <div class="small">Live Timer</div>
          <div id="timerDisplay" style="font-size:26px;font-weight:bold;margin:8px 0">00:00:00</div>
          <button id="startBtn" style="background:#28a745;color:white">Start Timer</button>
          <button id="stopBtn" style="background:#dc3545;color:white;display:none">Stop & Save</button>
        </div>
      </div>

      <div>
        <label class="small">Dark</label>
        <input type="checkbox" id="toggleDark" />
      </div>
    </header>

    <section class="top-row">
      <div class="card" style="flex:1">
        <div class="small">Today's Awake Total</div>
        <div class="big" id="awakeTotal">-- hrs</div>
        <div class="small">Awake Remaining</div>
        <div class="big" id="awakeRemaining">--:--:--</div>
      </div>

      <div class="card" style="width:320px">
        <div class="small">Target hours (daily)</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input type="number" id="targetHours" min="0" value="4" style="width:84px">
          <button id="saveTarget">Save</button>
          <div class="small" style="margin-left:auto">Remaining: <span id="targetRemaining">--:--</span></div>
        </div>
        <div class="small" style="margin-top:8px">Streak: <strong id="streak">0</strong> days</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between">
          <div>
            <div class="small">Add Session</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input type="time" id="sessionStart" />
              <input type="time" id="sessionEnd" />
              <button id="addSession">Add</button>
            </div>
          </div>
          <div style="text-align:right">
            <div class="small">Total logged today</div>
            <div class="big" id="loggedToday">0h 0m</div>
          </div>
        </div>

        <hr />

        <div class="small">Daily Log</div>
        <div class="log-list" id="logList"></div>
      </div>

      <div class="card">
        <div class="small">Weekly Calendar</div>
        <div id="calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>

        <hr />

        <div class="small">Weekly Line Chart</div>
        <div style="height:180px"><canvas id="weekChart"></canvas></div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* ========== STATE LOADING ========== */
    const STORAGE_KEY = 'live_hours_tracker_v1';
    const defaultState = { targetHours: 4, sessions: {} };
    let state = loadState();

    function loadState(){
      try{
        const x = JSON.parse(localStorage.getItem(STORAGE_KEY));
        return x ? x : defaultState;
      }catch(e){return defaultState;}
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function todayToKey(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    /* ========== TIMER LOGIC (SINGLE) ========== */
    let sec=0, liveTimer=null;
    const startBtn=document.getElementById('startBtn');
    const stopBtn=document.getElementById('stopBtn');
    const timerDisplay=document.getElementById('timerDisplay');

    startBtn.onclick=()=>{
      sec=0;
      startBtn.style.display='none';
      stopBtn.style.display='inline-block';
      liveTimer=setInterval(()=>{
        sec++;
        const h=String(Math.floor(sec/3600)).padStart(2,'0');
        const m=String(Math.floor((sec%3600)/60)).padStart(2,'0');
        const s=String(sec%60).padStart(2,'0');
        timerDisplay.textContent=`${h}:${m}:${s}`;
      },1000);
    };

    stopBtn.onclick=()=>{
      clearInterval(liveTimer);
      stopBtn.style.display='none';
      startBtn.style.display='inline-block';
      const durMin=Math.floor(sec/60);
      const key=todayToKey();
      if(!state.sessions[key]) state.sessions[key]=[];
      state.sessions[key].push({id:'t_'+Date.now(),start:'Timer',end:'Timer',durationMinutes:durMin});
      saveState();
      renderAll();
      timerDisplay.textContent='00:00:00';
    };

    /* ========== RENDER / SESSIONS ========== */
    const logList=document.getElementById('logList');
    const loggedToday=document.getElementById('loggedToday');

    function deleteSession(key,id){
      state.sessions[key]=state.sessions[key].filter(s=>s.id!==id);
      saveState();
      renderAll();
    }

    function renderLogList(){
      const key=todayToKey();
      const arr=state.sessions[key]||[];
      logList.innerHTML='';
      let total=0;

      arr.forEach(it=>{
        total+=it.durationMinutes;
        const div=document.createElement('div');
        div.className='log-item';
        div.innerHTML=`<div>${it.start} â†’ ${it.end}<br><span class='small'>${it.durationMinutes} min</span></div>`;
        const del=document.createElement('button');
        del.textContent='Delete';
        del.onclick=()=>deleteSession(key,it.id);
        div.appendChild(del);
        logList.appendChild(div);
      });

      loggedToday.textContent=`${Math.floor(total/60)}h ${total%60}m`;
    }

    document.getElementById('addSession').onclick=()=>{
      const s=document.getElementById('sessionStart').value;
      const e=document.getElementById('sessionEnd').value;
      if(!s||!e) return;
      const [sh,sm]=s.split(':').map(Number);
      const [eh,em]=e.split(':').map(Number);
      let dur=(eh*60+em)-(sh*60+sm);
      if(dur<0) return;
      const key=todayToKey();
      if(!state.sessions[key]) state.sessions[key]=[];
      state.sessions[key].push({id:'m_'+Date.now(),start:s,end:e,durationMinutes:dur});
      saveState();
      renderAll();
    };

    /* ========== TARGET HOURS ========== */
    document.getElementById('saveTarget').onclick=()=>{
      const v=Number(document.getElementById('targetHours').value);
      state.targetHours=v;
      saveState();
      renderAll();
    };

    function renderTargetRemaining(){
      const key=todayToKey();
      const arr=state.sessions[key]||[];
      let total=0;
      arr.forEach(s=>total+=s.durationMinutes);
      const rem=Math.max(0,state.targetHours*60-total);
      document.getElementById('targetRemaining').textContent=`${Math.floor(rem/60)}h ${rem%60}m`;
    }

    /* ========== CALENDAR + WEEK CHART ========== */
    const calendar=document.getElementById('calendar');
    let chart=null;

    function renderCalendar(){
      calendar.innerHTML='';
      const d=new Date();
      const day=d.getDay();
      const start=new Date(d);
      start.setDate(d.getDate()-day);

      for(let i=0;i<7;i++){
        const dt=new Date(start);
        dt.setDate(start.getDate()+i);
        const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        const arr=state.sessions[key]||[];
        let total=0;
        arr.forEach(s=>total+=s.durationMinutes);

        const div=document.createElement('div');
        div.style.padding='8px';
        div.style.textAlign='center';
        div.style.border='1px solid rgba(11,16,32,0.06)';
        div.style.borderRadius='8px';
        div.innerHTML=`<div style='font-weight:600'>${dt.getDate()}</div><div class='small'>${Math.floor(total/60)}h ${total%60}m</div>`;
        calendar.appendChild(div);
      }
    }

    function renderWeekChart(){
      const ctx=document.getElementById('weekChart');
      const d=new Date();
      const day=d.getDay();
      const start=new Date(d);
      start.setDate(d.getDate()-day);

      const labels=[];
      const data=[];
      for(let i=0;i<7;i++){
        const dt=new Date(start);
        dt.setDate(start.getDate()+i);
        const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        const arr=state.sessions[key]||[];
        let total=0;
        arr.forEach(s=>total+=s.durationMinutes);
        labels.push(dt.getDate());
        data.push(Math.floor(total/60));
      }

      if(chart) chart.destroy();
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,borderWidth:2}]} ,options:{responsive:true,plugins:{legend:{display:false}}}});
    }

    /* ========== RENDER ALL ========== */
    function renderAll(){
      const now=new Date();
      document.getElementById('todayDate').textContent=now.toDateString();
      renderLogList();
      renderTargetRemaining();
      renderCalendar();
      renderWeekChart();
    }

    renderAll();
  </script>
</body>
</html>